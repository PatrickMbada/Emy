###################################################
# Datastream Resources for MySQL to BigQuery Data Transfer
###################################################

# MySQL Source Connection Profile
resource "google_datastream_connection_profile" "mysql_source" {
  name     = "mysql-source-${local.env}-${random_string.random.result}"
  project  = google_project.scm_bq_comp.project_id
  location = "us-central1"

  mysql {
    hostname = var.mysql_hostname
    port     = var.mysql_port
    username = var.mysql_username
    password {
      secret_manager_secret_version = var.mysql_password_secret_version
    }
    ssl_config {
      client_key {
        secret_manager_secret_version = var.mysql_client_key_secret_version
      }
      client_certificate {
        secret_manager_secret_version = var.mysql_client_cert_secret_version
      }
      ca_certificate {
        secret_manager_secret_version = var.mysql_ca_cert_secret_version
      }
    }
  }
}

# BigQuery Destination Connection Profile
resource "google_datastream_connection_profile" "bq_destination" {
  name     = "bq-destination-${local.env}-${random_string.random.result}"
  project  = google_project.scm_bq_comp.project_id
  location = "us-central1"

  gcs {
    bucket_name = google_storage_bucket.infa_scm_bucket.name
    root_path   = "datastream-output/"
  }
}

# Datastream Stream Configuration
resource "google_datastream_stream" "mysql_to_bq_stream" {
  name       = "mysql-to-bq-stream-${local.env}-${random_string.random.result}"
  project    = google_project.scm_bq_comp.project_id
  location   = "us-central1"
  state      = "RUNNING"
  display_name = "MySQL to BigQuery Stream - ${local.env}"

  source_config {
    source_connection_profile = google_datastream_connection_profile.mysql_source.id
    mysql_source_config {
      include_objects {
        mysql_objects {
          database = var.mysql_database
          table    = var.mysql_tables # e.g., "users", "orders"
        }
      }
    }
  }

  destination_config {
    destination_connection_profile = google_datastream_connection_profile.bq_destination.id
    gcs_destination_config {
      file_rotation_mb       = 50
      file_rotation_interval = "15m"
    }
  }

  backfill_all {
    mysql_excluded_objects {
      mysql_objects {
        database = var.exclude_database
        table    = var.exclude_tables # Optional exclusion
      }
    }
  }

  depends_on = [
    google_datastream_connection_profile.mysql_source,
    google_datastream_connection_profile.bq_destination,
    google_bigquery_dataset.bode
  ]
}


variable "mysql_hostname" {
  description = "MySQL source hostname"
  type        = string
}

variable "mysql_port" {
  description = "MySQL source port"
  type        = number
  default     = 3306
}

variable "mysql_username" {
  description = "MySQL source username"
  type        = string
}

variable "mysql_password_secret_version" {
  description = "Secret Manager version for MySQL password"
  type        = string
}

variable "mysql_client_key_secret_version" {
  description = "Secret Manager version for MySQL client key"
  type        = string
}

variable "mysql_client_cert_secret_version" {
  description = "Secret Manager version for MySQL client certificate"
  type        = string
}

variable "mysql_ca_cert_secret_version" {
  description = "Secret Manager version for MySQL CA certificate"
  type        = string
}

variable "mysql_database" {
  description = "MySQL database name to replicate"
  type        = string
}

variable "mysql_tables" {
  description = "MySQL tables to replicate"
  type        = list(string)
}

variable "exclude_database" {
  description = "MySQL database to exclude from replication"
  type        = string
  default     = ""
}

variable "exclude_tables" {
  description = "MySQL tables to exclude from replication"
  type        = list(string)
  default     = []
}
